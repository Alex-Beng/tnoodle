<html>
<head>
<title>seeded-scrambler</title>
<style type="text/css">
h1, p, a, body {
	font-family: sans-serif;
}
.indexcol, .scramblecol {
	padding: 3px;
	font-weight: bold;
}
.scramblecol {
	font-family: monospace;
	font-size: 150%;
	width: 100%;
}
.imagecol {
	background-color: silver;
}
img {
	border: none;
}
area { cursor: pointer }
.a {text-decoration: none; cursor: pointer}
label.a { color: blue; text-decoration: underline; }
.a-selected {text-decoration: underline; cursor: pointer}
</style>
<!--
-->
<script type="text/javascript" src="mootools-1.2.4-core-yc.js"></script>
<script type="text/javascript" src="mootools-1.2.4.4-more.js"></script>
<script type="text/javascript" src="Color.js/Color.js"></script>
<script type="text/javascript" src="Source/ColorRoller.js"></script>
<link type="text/css" rel="stylesheet" href="Source/Assets/ColorRoller.css">
<script type="text/javascript">
	window.addEvent('load', function init() {
		CRImages = "Source/Assets/"; //gotta set this global variable
		color = new ColorRoller(null, { 
			onComplete:function(color) {
				colorScheme[selectedFace] = color.hexToRgb(true);
				refreshImages();
			}
		});
	});	
</script>
<script type="text/javascript">
// Like String.substring()
// http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Reference:Global_Objects:String:substring
// ----------------------------------------------------------------
Array.prototype.subarray = function( iIndexA, iIndexB ) {
// ----------------------------------------------------------------
	if(iIndexA < 0) iIndexA = 0;
	if(iIndexB == null || iIndexB > this.length) iIndexB = this.length;
	if(iIndexA == iIndexB) return [];
	var aReturn = new Array();
	for(var i=iIndexA; i<iIndexB; i++) {
		aReturn.push(this[i]);
	}
	return aReturn;
}

var server = 'http://localhost:8080';
function loadPuzzles(callback) {
	new Request.JSONP({
		url: server + "/scrambler.json",
		data: {
			
		},
		onComplete: callback
	}).send();
}

function loadScrambles(puzzle, count, seed, scheme, callback) {
	new Request.JSONP({
		url: server + "/scrambler/" + puzzle + ".json",
		data: {'count': count, 'seed': seed, 'scheme': scheme},
		onComplete: callback
	}).send();
}

function getScrambleImageURL(scramble) {
	var imageURI = new URI(server + "/viewer/" + query.puzzle + ".png");
	imageURI.setData({scramble: scramble, scheme: getColorScheme()});
	return imageURI.toString();
}

var increments = [];
function incrementalScramble(nth_scramble, increment) {
	if(increment === undefined)
		increment = scrambles[nth_scramble].length-1;
	increments[nth_scramble] = increment;
	var newScram = scrambles[nth_scramble].subarray(0, increment+1).join(" ");	
	$('scramble' + nth_scramble).setProperty('src', getScrambleImageURL(newScram));
	for(var i=0; i < scrambles[nth_scramble].length; i++) { //this'll unset the old one
		$('inc' + nth_scramble + ',' + i).set('class', i == increment ? 'a-selected' : 'a');
	}
}

function refreshImages() {
	$('schemer').set('src', getScrambleImageURL(''));
	for(var i = 0; i < scrambles.length; i++) {
		incrementalScramble(i);
	}
	$('scheme').set('value', getColorScheme());
}

var colorScheme = null;
var selectedFace = null;

function getColorScheme() {
	if(!colorScheme) return "";
	var faces = [];
	for(var face in colorScheme)
		faces.push(face);
	faces.sort();
	var colors = [];
	for(var i=0; i < faces.length; i++)
		colors.push(colorScheme[faces[i]].rgbToHex());
	return colors.join(",");
}

function createFaceMap() {
	new Request.JSONP({
		url: server + "/viewer/" + query.puzzle + ".json",
		data: {
			scheme: query.scheme
		},
		onComplete: function(data) {
			var area = "";
			colorScheme = {};
			for(var face in data) {
				colorScheme[face] = data[face].color;
				var coords = data[face].area.map(function(item) { return item.join(","); }).join(",");
				area += "<area name='" + face + "' shape='poly' coords='" + coords + "' onclick='selectedFace=\"" + face + "\"; color.setRGB(colorScheme[\"" + face + "\"], 3); color.show(this)' />";
			}
			$('facemap').set('html', area);
			$('schemer').set('src', getScrambleImageURL(''));
		},
	}).send();
}

function toggleSchemer() {
	var schemer = $('schemer');
	var display = (schemer.getStyle('display') == "none" ? "" : "none")
	schemer.setStyle("display", display);
}

function puzzleChanged() {
	$('scheme').set('value', '');
}

window.addEvent('domready', function() {
	//query is a global variable
	query = new URI().getData();
	query.count = query.count || '';
	query.seed = query.seed || '';
	query.scheme = query.scheme || '';
	
	loadPuzzles(function(puzzles) {
		var options = "";
		for(var i = 0; i < puzzles.length; i++) {
			options += '<option value="' + puzzles[i] + '"';
			if(puzzles[i] == query.puzzle)
				options += ' selected="selected"';
			options += '>' + puzzles[i] + '<\/option>';
		}
		document.getElementById('puzzle').innerHTML = options;
	});

	if(query.puzzle) {
		createFaceMap();
		loadScrambles(query.puzzle, query.count, query.seed, query.scheme, function(result) {
			scrambles = result.scrambles; //global variable!
			
			var table = $('scrambles');
			var html = "";
			var count = 0;
			for(var i = 0; i < scrambles.length; i++) {
				var scrams = scrambles[i].map(function(item, index) {
					var ret = '<span id="inc' + i + ',' + index + '" class="' + (index == scrambles[i].length-1 ? 'a-selected' : 'a');
					ret += '" onclick="incrementalScramble(' + i + ', ' + index + ');"';
					ret += '>' + item + '</span>';
					return ret;
				});
				var scrambleHTML = scrams.join(" ").replace(/\n/g, '<br>');
				
				html += '<tr><td class="indexcol">' + (++count) + '.</font><\/td>';
				html += '<td class="scramblecol">' + scrambleHTML + '<\/td>';
				html += '<td class="imagecol"><img id="scramble' + i + '" src="' + getScrambleImageURL(scrambles[i].join(" ")) + '"\/><\/td><\/tr>';
			}
			table.set('html', table.get('html') + html);
		});
	}
	
	var table = "";
	table += "<table id='scrambles' border='1' cellpadding=0 cellspacing=0 width='100%'>";
	table += "<tr><td colspan='3' bgcolor='#00c0c0'>";
	table += "<table width='100%' cellpadding='2' cellspacing='0'><tr>";
	table += "<td><label for='puzzle'>Puzzle:<\/label><select onchange='puzzleChanged()' id='puzzle' name='puzzle'><\/select><\/td>";
	table += "<td><label for='count'>Number of scrambles:<\/label><input id='count' name='count' size='2' maxlength='2' value='" + query.count + "' \/><\/td>";
	table += "<td><label for='seed'>Seed:<\/label><input id='seed' name='seed' size='10' value='" + query.seed + "' \/><\/td>";
	table += "<td><label class='a' onclick='toggleSchemer()' for='colors'>Colors:<\/label><input id='scheme' size='50' name='scheme' value='" + query.scheme + "' \/><\/td>";
	table += "<td><input type='submit' value='Scramble!' \/><\/td>";
	table += "<td><label class='a' onclick='help();'>Help!<\/label><\/td>";
	table += "<\/tr><\/table><\/td><\/tr><\/table>";
	$('form').innerHTML = table;
});
</script>
</head>
<body>
<!-- TODO http://mootools.net/forge/p/mooresize -->
<img id='schemer' src='' style='display: none;' usemap='#facemap'></img>
<map id='facemap' name='facemap'>
</map>
<form name='form' action='' id='form'>
</form>
</body>
</html>
