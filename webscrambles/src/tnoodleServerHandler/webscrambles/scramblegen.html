<!DOCTYPE html>
<html>
<head>
<title>WCA WebScrambler</title>

<style type="text/css">
#eventOptions {
position:absolute;
top:1px;
left:130px;
margin:5px;
padding:5px;
background-color:#eeeeee;
}

#eventNameDiv {
padding:3px;
font-weight:bold;
}

#roundOptions {
margin:2px;
padding:3px;
background-color:#dddddd;
}

table {
border-collapse:collapse;
}
tr.head {
background-color:#999999;
}
tr.even {
background-color:#cccccc;
}
tr.odd {
background-color:#eeeeee;
}

#head, #bottomPanel, #topPanel {
position:relative;
padding:5px;
}

#selector {
margin-left:0px;
margin-right:10px
}

body {
font-family:arial,sans-serif;
font-size:12px;
}
</style>

<script type="text/javascript" src="/moo/mootools-core-1.4.1.js"></script>
<script type="text/javascript" src="/moo/mootools-more-1.4.0.1.js"></script>
<script type="text/javascript" src="/moo/powertools-1.1.1.js"></script>
<script language="javascript">

var scrambleArray = [];

var eventHash = {};
eventHash['3x3']=['3x3','3x3x3',5];
eventHash['2x2']=['2x2','2x2x2',5];
eventHash['4x4']=['4x4','4x4x4',5];
eventHash['5x5']=['5x5','5x5x5',5];
eventHash['3x3oh']=['3x3 OH','3x3x3',5];
eventHash['3bld']=['3x3 BLD','3x3x3',3];
eventHash['6x6']=['6x6','6x6x6',3];
eventHash['7x7']=['7x7','7x7x7',3];
eventHash['pyra']=['Pyraminx','pyram',5];
eventHash['mega']=['Megaminx','mega',3];
eventHash['sq1']=['Square-1','sq1',5];
eventHash['clk']=['Rubiks Clock','clock',5];
eventHash['feet']=['3x3 with feet','3x3x3',3];
eventHash['fmc']=['Fewest Moves','3x3x3','fmc'];
eventHash['4bld']=['4x4 BLD','4x4x4',3];
eventHash['5bld']=['5x5 BLD','5x5x5',3];
eventHash['multi']=['3x3 Multi-BLD','3x3x3',20];

var cuboid = {};
cuboid['2x2x2']=1;
cuboid['3x3x3']=1;
cuboid['4x4x4']=1;
cuboid['5x5x5']=1;
cuboid['6x6x6']=1;
cuboid['7x7x7']=1;

function showEventOptions(events) {
	var d = document.getElementById('eventOptions');
	if (d) document.getElementById('topPanel').removeChild(d);
	
	var eventOptionsDiv = document.createElement('div');
	eventOptionsDiv.setAttribute('id','eventOptions');
	// eventOptionsDiv.setAttribute('style','position:absolute;top:1px;left:150px;margin:5px;padding:5px;background-color:#eeeeee');
	document.getElementById('topPanel').appendChild(eventOptionsDiv);
	
	var eventNameDiv = document.createElement('div');
	eventNameDiv.setAttribute('id','eventNameDiv');
	// eventNameDiv.setAttribute('style','padding:3px;font-weight:bold');
	document.getElementById('eventOptions').appendChild(eventNameDiv);

	var eventName = eventHash[events][0];
	var printEventName = document.createTextNode(eventName);
	document.getElementById('eventNameDiv').appendChild(printEventName);
	
	var text1 = document.createTextNode(" Rounds ");
	var text2 = document.createTextNode(" Scrambles ");
	var roundInput = document.createElement('input');
	roundInput.setAttribute('id','rounds');
	roundInput.setAttribute('type','number');
	roundInput.setAttribute('min','1');
	roundInput.setAttribute('max','5');
	roundInput.setAttribute('value','1');
	roundInput.setAttribute('size','1');

	document.getElementById('eventOptions').appendChild(text1);
	document.getElementById('eventOptions').appendChild(roundInput);
		
	if (events != 'fmc') {
		var scrambleInput = document.createElement('input');
		scrambleInput.setAttribute('id','scrambles');
		scrambleInput.setAttribute('type','number');
		scrambleInput.setAttribute('min','1');
		scrambleInput.setAttribute('max','40');
		scrambleInput.setAttribute('value',eventHash[events][2]);
		scrambleInput.setAttribute('size','1');
		document.getElementById('eventOptions').appendChild(text2);
		document.getElementById('eventOptions').appendChild(scrambleInput);
	}
		
	var submitButton = document.createElement('input');
	submitButton.setAttribute('type','submit');
	submitButton.setAttribute('value','Add');
	submitButton.setAttribute('style','margin:3px;');
	var clickFunction = function(){ showRoundOptions(events); };
	submitButton.onclick = clickFunction;
	document.getElementById('eventOptions').appendChild(submitButton);
	
}

function showRoundOptions(events) {
	var d = document.getElementById('roundOptions');
	if (d) document.getElementById('eventOptions').removeChild(d);

	var numRounds = document.getElementById('rounds').value;
	if (events == 'fmc') var numScrambles = 'fmc';
	else var numScrambles = document.getElementById('scrambles').value;

	var roundOptionsDiv = document.createElement('div');
	roundOptionsDiv.setAttribute('id','roundOptions');
	// roundOptionsDiv.setAttribute('style','margin:2px;padding:3px;background-color:#dddddd');
	document.getElementById('eventOptions').appendChild(roundOptionsDiv);
	
	for (i=1;i<=numRounds;i++) {
		var roundText = document.createTextNode(" Round "+i+" groups ");
		document.getElementById('roundOptions').appendChild(roundText);
		var groupsInput = document.createElement('input');
		groupsInput.setAttribute('id','groups_'+i);
		groupsInput.setAttribute('type','number');
		groupsInput.setAttribute('min','1');
		groupsInput.setAttribute('max','20');
		groupsInput.setAttribute('value','1');
		groupsInput.setAttribute('size','2');
		document.getElementById('roundOptions').appendChild(groupsInput);
		
		var copiesText = document.createTextNode(" Copies ");
		document.getElementById('roundOptions').appendChild(copiesText);
		var copiesInput = document.createElement('input');
		copiesInput.setAttribute('id','copies_'+i);
		copiesInput.setAttribute('type','number');
		copiesInput.setAttribute('min','1');
		copiesInput.setAttribute('max','10');
		copiesInput.setAttribute('value','1');
		copiesInput.setAttribute('size','2');
		document.getElementById('roundOptions').appendChild(copiesInput);
		var linebreak = document.createElement('br');
		document.getElementById('roundOptions').appendChild(linebreak);
	}
	
	var submitButton = document.createElement('input');
	submitButton.setAttribute('type','submit');
	submitButton.setAttribute('value','Add Scrambles');
	submitButton.setAttribute('style','margin:3px;');
	var clickFunction = function(){ addScrambles(events,numRounds,numScrambles) };
	submitButton.onclick = clickFunction;
	document.getElementById('roundOptions').appendChild(submitButton);
	
	var resetButton = document.createElement('input');
	resetButton.setAttribute('type','submit');
	resetButton.setAttribute('value','Reset');
	resetButton.setAttribute('style','margin:3px;');
	var clickFunction = function(){ resetEvent(); };
	resetButton.onclick = clickFunction;
	document.getElementById('roundOptions').appendChild(resetButton);

}

function addScrambles(events,rounds,scrambles) {
	var eventName = eventHash[events][0];
	var scrambleType = eventHash[events][1];
	
	if (cuboid[scrambleType]) var scheme = document.getElementById('colorScheme').value;
	
	for (i=1;i<=rounds;i++) {
		groupId = 'groups_'+i;
		copiesId = 'copies_'+i;
		var roundGroups = document.getElementById(groupId).value;
		var copies = document.getElementById(copiesId).value;
		if (roundGroups == 1) {
			if (!scrambleArray[eventName+' Round '+i]) {
				if (cuboid[scrambleType]) scrambleArray[eventName+' Round '+i]=[scrambleType,scrambles,copies,scheme];
				else scrambleArray[eventName+' Round '+i]=[scrambleType,scrambles,copies];
			}
			else alert(eventName+' Round '+i+' already exists; skipping');
		}
		
		else {
			for (j=1;j<=roundGroups;j++) {
				if (!scrambleArray[eventName+' Round '+i+' Group '+j]) {
					if (cuboid[scrambleType]) scrambleArray[eventName+' Round '+i+' Group '+j]=[scrambleType,scrambles,copies,scheme];
					else scrambleArray[eventName+' Round '+i+' Group '+j]=[scrambleType,scrambles,copies];
				}
				else alert(eventName+' Round '+i+' Group '+j+' already exists; skipping');
			}
		}
	}

	updateScrambleArray();
	
	var d = document.getElementById('eventOptions');
	document.getElementById('topPanel').removeChild(d);
}

function resetEvent() {
	var d = document.getElementById('eventOptions');
	document.getElementById('topPanel').removeChild(d);
}

function resetAllTheThings() {
	if (confirm("Reset all scrambles?")) {
		for (var i in scrambleArray) {
			delete scrambleArray[i];
		}
		updateScrambleArray();
		document.getElementById('formContainer').style.display = "none";
	}
}

function updateScrambleArray() {
	var headerRow = "<tr class='head'><th width=200>Event Title</th><th width=90>Scrambles</th><th width=90>Copies</th><th width=10>&nbsp;</th></tr>";
	var rows = '';
	var j = 0;
	for (var i in scrambleArray) {
		if (!scrambleArray[i][0]) break;
		if (j % 2 == 0) var rowColor="even";
		else var rowColor="odd";
		rows = rows+"<tr class='"+rowColor+"'><td>"+i+"</td><td align='center'>"+scrambleArray[i][1]+"</td><td align='center'>"+scrambleArray[i][2]+"</td><td align='center'><a href=\"javascript:deleteScramble('"+i+"')\">x</a></td></tr>";
		j++;
	}
	document.getElementById('scrambleTable').innerHTML=headerRow+rows;
	if (rows == '') document.getElementById('scrambleButton').disabled = "disabled";
	else document.getElementById('scrambleButton').removeAttribute('disabled');
	document.getElementById('formContainer').style.display = "none";
}

function deleteScramble(index) {
	delete scrambleArray[index];
	updateScrambleArray();
}

function scrambleAllTheThings() {
	var compName = document.getElementById('competitionName').value;
	if (compName == '') compName = 'scramble';

	var jsonUrl = compName+'.json?';
	var variableString = '';
	
	for (var i in scrambleArray) {
		if (!scrambleArray[i][0]) break;
		var puzzleRequest = scrambleArray[i].join('*');
		variableString = variableString+i+'='+puzzleRequest+'&';
	}
	
	jsonUrl = jsonUrl+variableString;

	var pendingScrambleRequest = new Request.JSON({
		url: jsonUrl,
		onRequest: function() {
			document.getElementById('scrambleButton').value = "loading...";
			document.getElementById('scrambleButton').disabled = "disabled";
		},
		onSuccess: function(responseJSON, responseText) {
			document.getElementById('scrambleButton').value = "Get Scrambles";
			if(responseJSON.error) {
				alert(responseText);
				return;
			}
			document.getElementById('scrambleButton').removeAttribute('disabled');
			document.getElementById('pdfScrambles').value = responseText;
			document.getElementById('pdfForm').action = '../view/'+compName+'.pdf';

			document.getElementById('zipScrambles').value = responseText;
			document.getElementById('zipForm').action = '../view/'+compName+'.zip';

			document.getElementById('formContainer').style.display = "block";
		},
		onFailure: function() {
		alert("Failure loading scrambles");
		document.getElementById('scrambleButton').value = "Get Scrambles";
		document.getElementById('scrambleButton').removeAttribute('disabled');
		}
	});
		pendingScrambleRequest.send();
}

</script>
</head>

<body>
<div id="head">
Competition Name: <input type="text" name="competitionName" id="competitionName" size="24" /> 
Color Scheme: <select name="colorScheme" id="colorScheme"> <option selected="selected" value="bygorw">Western</option><option value="ybgorw">Japanese</option></select>

</div>

<div id="topPanel">

<div id="selector">
<select id="eventName" size="17">
	<option value="3x3" onclick="javascript:showEventOptions('3x3');">Rubik's cube</option>
	<option value="2x2" onclick="javascript:showEventOptions('2x2');">2x2</option>
	<option value="4x4" onclick="javascript:showEventOptions('4x4');">4x4</option>
	<option value="5x5" onclick="javascript:showEventOptions('5x5');">5x5</option>
	<option value="3x3oh" onclick="javascript:showEventOptions('3x3oh');">3x3 one-handed</option>
	<option value="3bld" onclick="javascript:showEventOptions('3bld');">3x3 blindfolded</option>
	<option value="6x6" onclick="javascript:showEventOptions('6x6');">6x6</option>
	<option value="7x7" onclick="javascript:showEventOptions('7x7');">7x7</option>
	<option value="pyra" onclick="javascript:showEventOptions('pyra');">Pyraminx</option>
	<option value="mega" onclick="javascript:showEventOptions('mega');">Megaminx</option>
	<option value="sq1" onclick="javascript:showEventOptions('sq1');">Square-1</option>
	<option value="clk" onclick="javascript:showEventOptions('clk');">Clock</option>
	<option value="feet" onclick="javascript:showEventOptions('feet');">3x3 with feet</option>
	<option value="fmc" onclick="javascript:showEventOptions('fmc');">Fewest Moves</option>
	<option value="4bld" onclick="javascript:showEventOptions('4bld');">4x4 blindfolded</option>
	<option value="5bld" onclick="javascript:showEventOptions('5bld');">5x5 blindfolded</option>
	<option value="multi" onclick="javascript:showEventOptions('multi');">Multi BLD</option>
</select>
</div>

</div>

<div id="bottomPanel">
<table id="scrambleTable" cellspacing=0>
<tr class="head"><th width=200>Event Title</th><th width=90>Scrambles</th><th width=90>Copies</th><th width=10>&nbsp;</th></tr>
</table>
<div id="scrambleContainer" style="float:left;">
<input id="scrambleButton" type="submit" onclick="javascript:scrambleAllTheThings();" disabled="disabled" value="Get Scrambles">
<input type="submit" onclick="javascript:resetAllTheThings();" value="Reset All">

<div id="formContainer" style="display:none">
<form id="pdfForm" action="" method="POST" target="_blank">
<input id="pdfScrambles" type="hidden" name="scrambles" value='' />
<input type="submit" value=".pdf" />
</form>
<form id="zipForm" action="" method="POST" target="_blank">
<input id="zipScrambles" type="hidden" name="scrambles" value='' />
<input type="submit" value=".zip" />
</form>
</div>

</div>
</div>


</body>
</html>
