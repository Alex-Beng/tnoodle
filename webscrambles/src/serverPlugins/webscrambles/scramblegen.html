<html>
<head>

<script type="text/javascript" src="/moo/mootools-core-1.4.1.js"></script>
<script type="text/javascript" src="/moo/mootools-more-1.4.0.1.js"></script>
<script type="text/javascript" src="/moo/powertools-1.1.1.js"></script>

<script type="text/javascript">
(function() {

History.handleInitialState('/scramble/');
	
function assert(bool, str) {
	if(!bool) {
		alert("Assertion error: " + str);
	}
}

var round2RoundRequest = null;
function parseUrl() {
	var uri = new URI(History.getPath());
	var pathname = uri.get('directory') + uri.get('file');
	var PATH_RE = /^\/?scramble\/?(.*?)(\.html)?$/;
	var match = PATH_RE.exec(pathname);
	assert(match, pathname + " doesn't match " + PATH_RE);

	var title = decodeURIComponent(match[1]);
	globalTitle.value = title;
	
	document.title = title + " - WCA Scrambler";
	
	round2RoundRequest = uri.getData();
	for(var round in round2RoundRequest) {
		if(round2RoundRequest[round] instanceof Array) {
			alert("Multiple rounds with the same name (" + round + ") not allowed. I'm choosing one of them at random.");
			round2RoundRequest[round] = round2RoundRequest[round][0];
		}
		
		var puzzle_count_copies_scheme = round2RoundRequest[round].split("*");
		var puzzle;
		var countStr = "";
		var copiesStr = "";
		var scheme = "";
		switch(puzzle_count_copies_scheme.length) {
		case 4:
			scheme = puzzle_count_copies_scheme[3];
		case 3:
			copiesStr = puzzle_count_copies_scheme[2];
		case 2:
			countStr = puzzle_count_copies_scheme[1];
		case 1:
			puzzle = puzzle_count_copies_scheme[0];
			break;
		default:
			alert("Invalid scramble request: " + round2RoundRequest[round]);
		}
		
		if(!(puzzle in puzzle2LongName)) {
			alert("Invalid puzzle: " + puzzle + ". Ignoring scramble request");
			delete round2RoundRequest[round]; 
		} else {
			round2RoundRequest[round] = { puzzle: puzzle, count: countStr.toInt() || 1, copies: copiesStr.toInt() || 1, scheme: scheme };
		}
	}
	
	var pdfUrl = getUrl('pdf');
	pdfLink.set('href', pdfUrl);
	pdfLink.set('text', pdfUrl);
	var zipUrl = getUrl('zip');
	zipLink.set('href', zipUrl);
	zipLink.set('text', zipUrl);
}

// This is a pointless attempt to keep the urls human readable.
function roundRequestToString(roundRequest) {
	var str = "";
	if(roundRequest.scheme) {
		str = "*" + roundRequest.scheme + str;
	}
	if(str.length > 0 || roundRequest.copies != 1) {
		str = "*" + roundRequest.copies + str;
	}
	if(str.length > 0 || roundRequest.count != 1) {
		str = "*" + roundRequest.count + str;		
	}
	str = roundRequest.puzzle + str;
	return encodeURIComponent(str);
}

function getUrl(ext) {
	var scrambleRequests = "";
	for(var roundTitle in round2RoundRequest) {
		var roundRequest = round2RoundRequest[roundTitle];
		scrambleRequests += "&" + encodeURIComponent(roundTitle) + "=" + roundRequestToString(roundRequest);
	}
	if(scrambleRequests.length == 0) {
		if(ext == "html") {
			// A url without scramble requests is only valid if it's an html url
			if(globalTitle.value) {
				return "/scramble/" + encodeURIComponent(globalTitle.value) + ".html";
			} else {
				return "/scramble/";
			}
		}
		return null;
	}
	scrambleRequests = "?" + scrambleRequests.substring(1);
	
	return "/scramble/" + encodeURIComponent(globalTitle.value) + "." + encodeURIComponent(ext) + scrambleRequests;
}

function somethingChanged() {
	// Calling History.push will cause parseUrl() to get called.
	var htmlUrl = getUrl("html");
	if(htmlUrl != History.getPath()) {
		History.push(htmlUrl);
	}
}

function globalTitleChanged() {
	somethingChanged();
}

var globalTitle = null;
var pdfLink = null;
var zipLink;
var puzzle2LongName = {};

window.addEvent('domready', function() {
	globalTitle = $('globalTitle');
	pdfLink = $('pdfLink');
	zipLink = $('zipLink');

	
	var puzzleRequest = new Request.JSON({
		url: "/puzzles/",
		onSuccess: function(responseJSON, responseText) {
			for(var i = 0; i < responseJSON.length; i++) {
				var shortName = responseJSON[i][0];
				var longName = responseJSON[i][1];
				assert(!(shortName in puzzle2LongName));
				puzzle2LongName[shortName] = longName;
			}
			parseUrl();
			History.addEvent('change', parseUrl);
			
			globalTitle.addEvent('input', globalTitleChanged);
		},
		onFailure: function() {
			// TODO
			alert("Failure loading scrambles");
		}
	});
	puzzleRequest.send();
});

})();
</script>

</head>
<body>
<input type="text" id="globalTitle"></input>
<a id="pdfLink" href="" target="_blank"></a>
<a id="zipLink" href="" target="_blank"></a>
</body>
</html>

<!-- 
<html>

<head>
<title>WCA Scramble Maker</title>
<script type="text/javascript">

function scrambleLink(link,puzzlename,title) {
	document.getElementById(link).setAttribute('action',document.location.origin+'/scramble/' + document.getElementById(puzzlename).value + '.' + document.getElementById(title).value + '.pdf');
}

var cubeType = new Array();
cubeType['2x2x2'] = 'cuboid';
cubeType['3x3x3'] = 'cuboid';
cubeType['4x4x4'] = 'cuboid';
cubeType['5x5x5'] = 'cuboid';
cubeType['6x6x6'] = 'cuboid';
cubeType['7x7x7'] = 'cuboid';
cubeType['clock'] = 'noncuboid';
cubeType['pyro'] = 'noncuboid';
cubeType['mega'] = 'noncuboid';
cubeType['sq1wca'] = 'noncuboid';

var schemes = new Array();
schemes['cuboid'] = new Array();
schemes['cuboid'][0] = new Array('Western','Japanese');
schemes['cuboid'][1] = new Array('bygorw','ybgorw');
schemes['noncuboid'] = new Array();
schemes['noncuboid'][0] = new Array('Default');
schemes['noncuboid'][1] = new Array('');

function emptyList(box) {
	while (box.options.length) box.options[0] = null;
}

function fillList(box,arr) {
	for(i=0; i<arr[0].length; i++) {
		option = new Option(arr[0][i], arr[1][i]);
		box.options[box.length] = option;
	}
	box.selectedIndex=0;
}

function changeList(box) {
	list = schemes[cubeType[box.options[box.selectedIndex].value]];
	emptyList(box.form.scheme);
	fillList(box.form.scheme,list);
}

</script>
<style type="text/css">
body {
	font-family:Tahoma,Arial,Verdana,sans-serif;
	font-size:13px;
}
div#main {
	padding:8px;
	border:1px solid;
	background-color:#66cc66;
}
div.color {
	width:10px;
	height:10px;
	margin-bottom:2px;
}
input, select, table {
	font-family:Tahoma,Arial,Verdana,sans-serif;
	font-size:13px;
}
</style>
</head>

<body>
<div id="main">
<table border=0>
<tr>
<td width=95%>
<form name="scramblepdf" id="scramblepdf" action="" target=_blank>
Puzzle:
<select id="puzzlename" onchange="scrambleLink('scramblepdf','puzzlename','title'); changeList(this)">
<option selected="selected" value="3x3x3">3x3x3</option>
<option value="2x2x2">2x2x2</option>
<option value="4x4x4">4x4x4</option>
<option value="5x5x5">5x5x5</option>
<option value="6x6x6">6x6x6</option>
<option value="7x7x7">7x7x7</option>
<option value="clock">Clock</option>
<option value="pyro">Pyraminx</option>
<option value="mega">Megaminx</option>
<option value="sq1wca">Square-1</option>
</select>
Title:
<input type="text" id="title" title="e.g. Round 1" onchange="scrambleLink('scramblepdf','puzzlename','title');">
Count:
<select name="count" id="count">
<option value=1>1</option>
<option value=3>3</option>
<option selected="selected" value=5>5</option>
</select>
Color scheme:
<select name="scheme" id="scheme">
<option selected="selected" value=bygorw>Western</option>
<option value=ybgorw>Japanese</option>
</select>
<input type="submit" id="submitbutton" value="Get Scrambles">
</form>
</td>
<td>
<div style="margin-left:98%;">
<a href=# onclick="javascript:document.getElementById('main').style.backgroundColor = '#cc6666';"><div class="color" style="background-color:#cc6666;"></div></a>
<a href=# onclick="javascript:document.getElementById('main').style.backgroundColor = '#66cc66';"><div class="color" style="background-color:#66cc66;"></div></a>
<a href=# onclick="javascript:document.getElementById('main').style.backgroundColor = '#6666ff';"><div class="color" style="background-color:#6666ff;"></div></a>
</div>
</td>
</tr>
</table>
</div>

<script type="text/javascript">
scrambleLink('scramblepdf','puzzlename','title');
</script>
</body>
</html>
 -->