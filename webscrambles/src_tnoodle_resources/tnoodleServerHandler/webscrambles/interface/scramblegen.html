<!DOCTYPE html>
<html>
<head>
<title>WCA Scrambler</title>

<script type="text/javascript" src="/scrambler-interface/js/ui.js"></script>
<link type="text/css" href="/scrambler-interface/css/ui.css" rel="stylesheet" />

<script type="text/javascript" src="/js/scramble.js"></script>

<script type="text/javascript">
(function() {
	var scrambleServer = new tnoodle.ScrambleServer();

	function toScrambleRequest(sheets) {
		var scrambleRequest = [];
		for(var i = 0; i < sheets.length; i++) {
			var sheet = sheets[i];
			var scrambles = requestsByGuid[sheet.guid].scrambles;
			assert(scrambles.length >= sheet.scrambleCount);
			// It's possible we generated more scrambles than we actually need.
			scrambles = scrambles.slice(0, sheet.scrambleCount);
			var request = {
				scrambles: scrambles,
				copies: 1, //TODO - add support for this to ui.js
				scrambler: sheet.puzzle,
				count: sheet.scrambleCount,
				title: sheet.title,
				fmc: sheet.fmc
			};
			scrambleRequest.push(request);
		}
		return scrambleRequest;
	}
	function showZip(e) {
		var title = mark2.ui.getTitle();
		var sheets = mark2.ui.getScrambleSheets();
		var request = toScrambleRequest(sheets);
		var password = mark2.ui.getPassword();
		if(e.shiftKey) {
			scrambleServer.showPdf(title, request, password, "_blank");
		} else {
			scrambleServer.showZip(title, request, password, "");
		}
	}

	var requestsByGuid = {};
	var title = "";
	function toScramblesByGuid(requestsByGuid) {
		var scramblesByGuid = {};
		for(var guid in requestsByGuid) {
			if(requestsByGuid.hasOwnProperty(guid)) {
				scramblesByGuid[guid] = requestsByGuid[guid].scrambles;
			}
		}
		return scramblesByGuid;
	}

	function scramblesLoaded(sheet, requestIndex, newScrambles) {
		var scrambles = requestsByGuid[sheet.guid].scrambles;
		var firstNullIndex = Math.max(0, scrambles.indexOf(null));
		for(var i = 0; i < newScrambles.length; i++) {
			scrambles[firstNullIndex + i] = newScrambles[i];
		}
		requestsByGuid[sheet.guid].pendingRequests[requestIndex] = null;
		mark2.ui.scramblesGenerated(toScramblesByGuid(requestsByGuid));

		// Perhaps there's more work to be done
		competitionChanged();
	}

	function competitionChanged() {
		var requestedGuids = {};
		var sheets = mark2.ui.getScrambleSheets();
		var request, i;
		for(i = 0; i < sheets.length; i++) {
			var sheet = sheets[i];
			request = requestsByGuid[sheet.guid];
			requestedGuids[sheet.guid] = true;

			if(!request) {
				request = {
					scrambles: [],
					pendingRequests: []
				};
				requestsByGuid[sheet.guid] = request;
			}

			if(request.scrambles.length < sheet.scrambleCount) {
				var seed = null;
				var MAX_SCRAMBLES_PER_REQUEST = 10;
				var unrequestedScrambleCount = sheet.scrambleCount - request.scrambles.length;
				var scramblesToRequest = Math.min(unrequestedScrambleCount, MAX_SCRAMBLES_PER_REQUEST);
				request.scrambles.length += scramblesToRequest;

				var requestIndex = request.pendingRequests.length;
				var pendingRequest = scrambleServer.loadScrambles(scramblesLoaded.bind(null, sheet, requestIndex), sheet.puzzle, seed, scramblesToRequest);
				request.pendingRequests.push(pendingRequest);
			}
		}

		for(var guid in requestsByGuid) {
			if(requestsByGuid.hasOwnProperty(guid)) {
				if(!requestedGuids[guid]) {
					// This request is no longer needed, so we abort it if
					// it's still running, and then delete it.
					request = requestsByGuid[guid];
					for(i = 0; i < request.pendingRequests.length; i++) {
						if(request.pendingRequests[i]) {
							request.pendingRequests[i].abort();
						}
					}
					delete requestsByGuid[guid];
				}
			}
		}
	}

	var removeTempDiv = function() {
		var tempDiv = document.getElementById("temp_div");
		document.body.removeChild(tempDiv);
	};

	var callbacks = {
		showScrambles: showZip,
		competitionChanged: competitionChanged
	};
	
	window.addEventListener('load', function() {
		var tnoodleLinkSpan = document.createElement('span');
		var tnoodleLink = document.createElement('a');
		tnoodleLink.href = '/readme';
		tnoodleLink.appendChild(document.createTextNode("TNoodle"));
		tnoodleLinkSpan.appendChild(tnoodleLink);
		tnoodleLinkSpan.appendChild(document.createTextNode(" WCA Scrambler"));
		var div = mark2.ui.initialize(tnoodleLinkSpan, callbacks);
		removeTempDiv();
		document.body.appendChild(div);
	}, false);

})();
</script>

</head>
<body>

<div id="temp_div" style="text-align: center; margin: 2em; font-family: sans-serif; font-size: 20px;">
	Loading scramble interface...
</div>

</body>
</html>
