<!DOCTYPE html>
<html>
<head>
<title>WCA WebScrambler</title>

<style type="text/css">
#eventOptions {
position:absolute;
top:1px;
left:130px;
margin:5px;
padding:5px;
background-color:#eeeeee;
}

#eventNameDiv {
padding:3px;
font-weight:bold;
}

#roundOptions {
margin:2px;
padding:3px;
background-color:#dddddd;
}

table {
border-collapse:collapse;
}
tr.head {
background-color:#999999;
}
tr.even {
background-color:#cccccc;
}
tr.odd {
background-color:#eeeeee;
}

#head, #bottomPanel, #topPanel {
position:relative;
padding:5px;
}

#selector {
margin-left:0px;
margin-right:10px
}

body {
font-family:arial,sans-serif;
font-size:12px;
}
</style>

<script type="text/javascript" src="/moo/mootools-core-1.4.1.js"></script>
<script type="text/javascript" src="/moo/mootools-more-1.4.0.1.js"></script>
<script type="text/javascript" src="/moo/powertools-1.1.1.js"></script>
<script language="javascript">


var scrambleArray = {};
var pendingScrambleRequest = null;

var eventHash = {};
eventHash['3x3']={ eventName: '3x3', scrambleType: '3x3x3', defaultScrambles: 5};
eventHash['2x2']={ eventName: '2x2', scrambleType: '2x2x2', defaultScrambles: 5};
eventHash['4x4']={ eventName: '4x4', scrambleType: '4x4x4', defaultScrambles: 5};
eventHash['5x5']={ eventName: '5x5', scrambleType: '5x5x5', defaultScrambles: 5};
eventHash['3x3oh']={ eventName: '3x3 OH', scrambleType: '3x3x3', defaultScrambles: 5};
eventHash['3bld']={ eventName: '3x3 BLD', scrambleType: '3x3x3', defaultScrambles: 3};
eventHash['6x6']={ eventName: '6x6', scrambleType: '6x6x6', defaultScrambles: 3};
eventHash['7x7']={ eventName: '7x7', scrambleType: '7x7x7', defaultScrambles: 3};
eventHash['pyra']={ eventName: 'Pyraminx', scrambleType: 'pyram', defaultScrambles: 5};
eventHash['mega']={ eventName: 'Megaminx', scrambleType: 'mega', defaultScrambles: 3};
eventHash['sq1']={ eventName: 'Square-1', scrambleType: 'sq1', defaultScrambles: 5};
eventHash['clk']={ eventName: 'Rubiks Clock', scrambleType: 'clock', defaultScrambles: 5};
eventHash['feet']={ eventName: '3x3 with feet', scrambleType: '3x3x3', defaultScrambles: 3};
eventHash['fmc']={ eventName: 'Fewest Moves', scrambleType: '3x3x3', defaultScrambles: 'fmc'};
eventHash['4bld']={ eventName: '4x4 BLD', scrambleType: '4x4x4', defaultScrambles: 3};
eventHash['5bld']={ eventName: '5x5 BLD', scrambleType: '5x5x5', defaultScrambles: 3};
eventHash['multi']={ eventName: '3x3 Multi-BLD', scrambleType: '3x3x3', defaultScrambles: 20};

var cuboid = {};
cuboid['2x2x2']=1;
cuboid['3x3x3']=1;
cuboid['4x4x4']=1;
cuboid['5x5x5']=1;
cuboid['6x6x6']=1;
cuboid['7x7x7']=1;

function showEventOptions(events) {
	var d = document.getElementById('eventOptions');
	if (d) document.getElementById('topPanel').removeChild(d);
	
	var eventOptionsDiv = document.createElement('div');
	eventOptionsDiv.setAttribute('id','eventOptions');
	document.getElementById('topPanel').appendChild(eventOptionsDiv);
	
	var eventNameDiv = document.createElement('div');
	eventNameDiv.setAttribute('id','eventNameDiv');
	document.getElementById('eventOptions').appendChild(eventNameDiv);

	var eventName = eventHash[events].eventName;
	var printEventName = document.createTextNode(eventName);
	document.getElementById('eventNameDiv').appendChild(printEventName);
	
	var text1 = document.createTextNode(" Rounds ");
	var text2 = document.createTextNode(" Scrambles ");
	var roundInput = document.createElement('input');
	roundInput.setAttribute('id','rounds');
	roundInput.setAttribute('type','number');
	roundInput.setAttribute('min','1');
	roundInput.setAttribute('max','5');
	roundInput.setAttribute('value','1');
	roundInput.setAttribute('size','1');
	var clickFunction = function(){ showRoundOptions(events); };
	roundInput.onclick = clickFunction;
	roundInput.onblur = clickFunction;
	roundInput.onkeypress = clickFunction;
	roundInput.onchange = clickFunction;

	document.getElementById('eventOptions').appendChild(text1);
	document.getElementById('eventOptions').appendChild(roundInput);
		
	if (events != 'fmc') {
		var scrambleInput = document.createElement('input');
		scrambleInput.setAttribute('id','scrambles');
		scrambleInput.setAttribute('type','number');
		scrambleInput.setAttribute('min','1');
		scrambleInput.setAttribute('max','40');
		scrambleInput.setAttribute('value',eventHash[events].defaultScrambles);
		scrambleInput.setAttribute('size','1');
		scrambleInput.onclick = clickFunction;
		scrambleInput.onblur = clickFunction;
		scrambleInput.onkeypress = clickFunction;
		scrambleInput.onchange = clickFunction;
		document.getElementById('eventOptions').appendChild(text2);
		document.getElementById('eventOptions').appendChild(scrambleInput);
	}
	showRoundOptions(events)
}

function showRoundOptions(events) {
	var d = document.getElementById('roundOptions');
	if (d) document.getElementById('eventOptions').removeChild(d);

	var numRounds = document.getElementById('rounds').value;
	if (events == 'fmc') var numScrambles = 'fmc';
	else var numScrambles = document.getElementById('scrambles').value;

	var roundOptionsDiv = document.createElement('div');
	roundOptionsDiv.setAttribute('id','roundOptions');
	document.getElementById('eventOptions').appendChild(roundOptionsDiv);
	
	for (i=1;i<=numRounds;i++) {
		var roundText = document.createTextNode(" Round "+i+" groups ");
		document.getElementById('roundOptions').appendChild(roundText);
		var groupsInput = document.createElement('input');
		groupsInput.setAttribute('id','groups_'+i);
		groupsInput.setAttribute('type','number');
		groupsInput.setAttribute('min','1');
		groupsInput.setAttribute('max','20');
		groupsInput.setAttribute('value','1');
		groupsInput.setAttribute('size','2');
		document.getElementById('roundOptions').appendChild(groupsInput);
		
		var copiesText = document.createTextNode(" Copies ");
		document.getElementById('roundOptions').appendChild(copiesText);
		var copiesInput = document.createElement('input');
		copiesInput.setAttribute('id','copies_'+i);
		copiesInput.setAttribute('type','number');
		copiesInput.setAttribute('min','1');
		copiesInput.setAttribute('max','10');
		copiesInput.setAttribute('value','1');
		copiesInput.setAttribute('size','2');
		document.getElementById('roundOptions').appendChild(copiesInput);
		var linebreak = document.createElement('br');
		document.getElementById('roundOptions').appendChild(linebreak);
	}
	
	var submitButton = document.createElement('input');
	submitButton.setAttribute('type','submit');
	submitButton.setAttribute('value','Add Scrambles');
	submitButton.setAttribute('style','margin:3px;');
	var clickFunction = function(){ addScrambles(events,numRounds,numScrambles) };
	submitButton.onclick = clickFunction;
	document.getElementById('roundOptions').appendChild(submitButton);
	
	var resetButton = document.createElement('input');
	resetButton.setAttribute('type','submit');
	resetButton.setAttribute('value','Reset');
	resetButton.setAttribute('style','margin:3px;');
	var clickFunction = function(){ resetEvent(); };
	resetButton.onclick = clickFunction;
	document.getElementById('roundOptions').appendChild(resetButton);

}

function addScrambles(events,rounds,scrambles) {
	var eventName = eventHash[events].eventName;
	var scrambleType = eventHash[events].scrambleType;
	
	if (cuboid[scrambleType]) var scheme = document.getElementById('colorScheme').value;
	
	for (var i=1;i<=rounds;i++) {
		var groupId = 'groups_'+i;
		var copiesId = 'copies_'+i;
		var roundGroups = document.getElementById(groupId).value;
		var copies = document.getElementById(copiesId).value;
		for (var j=1;j<=roundGroups;j++) {
			if (rounds > 1) var roundTitle = eventName+' Round '+i;
			else var roundTitle = eventName;
			if (roundGroups > 1) roundTitle += ' Group '+j;
 			if (!scrambleArray[roundTitle]) {
  				if (cuboid[scrambleType]) scrambleArray[roundTitle]={ scrambleType: scrambleType, scrambleCount: scrambles, copies: copies, scheme: scheme };
 				else scrambleArray[roundTitle]={ scrambleType: scrambleType, scrambleCount: scrambles, copies: copies };
 			}
 			else alert(roundTitle + ' already exists; skipping');
		}
	}

	updateScrambleTable();
	
	var d = document.getElementById('eventOptions');
	document.getElementById('topPanel').removeChild(d);
}

function editScrambles() {
	// TODO
}

function updateScrambles() {
	// TODO
}

function resetEvent() {
	var d = document.getElementById('eventOptions');
	document.getElementById('topPanel').removeChild(d);
}

function resetAllTheThings() {
	if (confirm("Reset all scrambles?")) {
		for (var i in scrambleArray) {
			delete scrambleArray[i];
		}
		if (pendingScrambleRequest) {
			pendingScrambleRequest.cancel();
			pendingScrambleRequest = null;
			document.getElementById('scrambleButton').value = "Get Scrambles";
			document.getElementById('scrambleButton').removeAttribute('disabled');
		}
		updateScrambleTable();
		document.getElementById('formContainer').style.display = "none";
	}
}

function updateScrambleTable() {
	var headerRow = document.createElement('tr');
	headerRow.setAttribute('class','head');
	headerRow.setAttribute('id','headerRow');

	var headerCellTitle = document.createElement('th');
	headerCellTitle.setAttribute('width','200');
	headerCellTitle.innerHTML = 'Event Title';

	var headerCellScrambles = document.createElement('th');
	headerCellScrambles.setAttribute('width','90');
	headerCellScrambles.innerHTML = 'Scrambles';

	var headerCellCopies = document.createElement('th');
	headerCellCopies.setAttribute('width','90');
	headerCellCopies.innerHTML = 'Copies';

	var headerCellBlank = document.createElement('th');
	headerCellBlank.setAttribute('width','10');
	headerCellBlank.innerHTML = '&nbsp\x3B';

	document.getElementById('scrambleTable').innerHTML='';
	document.getElementById('scrambleTable').appendChild(headerRow);
	document.getElementById('headerRow').appendChild(headerCellTitle);
	document.getElementById('headerRow').appendChild(headerCellScrambles);
	document.getElementById('headerRow').appendChild(headerCellCopies);
	document.getElementById('headerRow').appendChild(headerCellBlank);

	var j = 0;
	for (var i in scrambleArray) {
		if (j % 2 == 0) var rowColor="even";
		else var rowColor="odd";

		var newRow = document.createElement('tr');
		newRow.setAttribute('class',rowColor);
		var rowId = 'row'+j;
		newRow.setAttribute('id',rowId);

		var titleCell = document.createElement('td');
		var titleId = 'title'+j;
		titleCell.setAttribute('id',titleId);
		titleCell.innerHTML = i;

		var scramblesCell = document.createElement('td');
		var scramblesId = 'scrambles'+j;
		scramblesCell.setAttribute('id',scramblesId);
		scramblesCell.setAttribute('align','center');
		scramblesCell.innerHTML = scrambleArray[i].scrambleCount;

		var copiesCell = document.createElement('td');
		var copiesId = 'copies'+j;
		copiesCell.setAttribute('id',copiesId);
		copiesCell.setAttribute('align','center');
		copiesCell.innerHTML = scrambleArray[i].copies;

		var deleteCell = document.createElement('td');
		var deleteId = 'delete'+j;
		deleteCell.setAttribute('id',deleteId);
		deleteCell.innerHTML = "<a href=\"javascript:deleteScramble('"+i+"')\">x</a>";

		document.getElementById('scrambleTable').appendChild(newRow);
		document.getElementById(rowId).appendChild(titleCell);
		document.getElementById(rowId).appendChild(scramblesCell);
		document.getElementById(rowId).appendChild(copiesCell);
		document.getElementById(rowId).appendChild(deleteCell);

		j++;
	}
	if (j == 0) document.getElementById('scrambleButton').disabled = "disabled";
	else document.getElementById('scrambleButton').removeAttribute('disabled');
	document.getElementById('formContainer').style.display = "none";
}

function deleteScramble(index) {
	delete scrambleArray[index];
	updateScrambleTable();
}

function request2String(i) {
	var str = scrambleArray[i].scrambleType+'*'+scrambleArray[i].scrambleCount+'*'+scrambleArray[i].copies;
	var scrambleType = scrambleArray[i].scrambleType;
	if (cuboid[scrambleType]) {
		str = str+'*'+scrambleArray[i].scheme;
	}
	return str;
}
function request2Uri(scrambleArray) {
	var uri = ''
	for (var roundTitle in scrambleArray) {
		var str = request2String(roundTitle);
		if (uri != '') uri += '&';
		uri += roundTitle+'='+str;
	}
	return uri;	
}

function scrambleAllTheThings() {
	var compName = document.getElementById('globalTitle').value;
	compName = encodeURIComponent(compName);
	if (compName == '') compName = 'scramble';

	var jsonUrl = compName+'.json?';
	var variableString = request2Uri(scrambleArray);
	
	jsonUrl += variableString;

	pendingScrambleRequest = new Request.JSON({
		url: jsonUrl,
		onRequest: function() {
			document.getElementById('scrambleButton').value = "loading...";
			document.getElementById('scrambleButton').disabled = "disabled";
		},
		onSuccess: function(responseJSON, responseText) {
			document.getElementById('scrambleButton').value = "Get Scrambles";
			if(responseJSON.error) {
				alert(responseText);
				return;
			}
			document.getElementById('scrambleButton').removeAttribute('disabled');
			document.getElementById('pdfScrambles').value = responseText;
			document.getElementById('pdfForm').action = '../view/'+compName+'.pdf';

			document.getElementById('zipScrambles').value = responseText;
			document.getElementById('zipForm').action = '../view/'+compName+'.zip';

			document.getElementById('formContainer').style.display = "block";
		},
		onFailure: function() {
		alert("Failure loading scrambles");
		document.getElementById('scrambleButton').value = "Get Scrambles";
		document.getElementById('scrambleButton').removeAttribute('disabled');
		}
	});
		pendingScrambleRequest.send();
}

</script>
</head>

<body>
<div id="head">
Competition Name: <input type="text" id="globalTitle" size="24" /> 
Color Scheme: <select name="colorScheme" id="colorScheme"> <option selected="selected" value="bygorw">Western</option><option value="ybgorw">Japanese</option></select>

</div>

<div id="topPanel">

<div id="selector">

<select id="eventSelector" size="17">
	<option value="3x3" onclick="javascript:showEventOptions('3x3');">Rubik's cube</option>
	<option value="2x2" onclick="javascript:showEventOptions('2x2');">2x2</option>
	<option value="4x4" onclick="javascript:showEventOptions('4x4');">4x4</option>
	<option value="5x5" onclick="javascript:showEventOptions('5x5');">5x5</option>
	<option value="3x3oh" onclick="javascript:showEventOptions('3x3oh');">3x3 one-handed</option>
	<option value="3bld" onclick="javascript:showEventOptions('3bld');">3x3 blindfolded</option>
	<option value="6x6" onclick="javascript:showEventOptions('6x6');">6x6</option>
	<option value="7x7" onclick="javascript:showEventOptions('7x7');">7x7</option>
	<option value="pyra" onclick="javascript:showEventOptions('pyra');">Pyraminx</option>
	<option value="mega" onclick="javascript:showEventOptions('mega');">Megaminx</option>
	<option value="sq1" onclick="javascript:showEventOptions('sq1');">Square-1</option>
	<option value="clk" onclick="javascript:showEventOptions('clk');">Clock</option>
	<option value="feet" onclick="javascript:showEventOptions('feet');">3x3 with feet</option>
	<option value="fmc" onclick="javascript:showEventOptions('fmc');">Fewest Moves</option>
	<option value="4bld" onclick="javascript:showEventOptions('4bld');">4x4 blindfolded</option>
	<option value="5bld" onclick="javascript:showEventOptions('5bld');">5x5 blindfolded</option>
	<option value="multi" onclick="javascript:showEventOptions('multi');">Multi BLD</option>
</select>

</div>

</div>

<div id="bottomPanel">
<table id="scrambleTable" cellspacing=0>
<tr class="head"><th width=200>Event Title</th><th width=90>Scrambles</th><th width=90>Copies</th><th width=10>&nbsp;</th></tr>
</table>
<div id="scrambleContainer" style="float:left;">
<input id="scrambleButton" type="submit" onclick="javascript:scrambleAllTheThings();" disabled="disabled" value="Get Scrambles">
<input type="submit" onclick="javascript:resetAllTheThings();" value="Reset All">

<div id="formContainer" style="display:none">
<form id="pdfForm" action="" method="POST" target="_blank">
<input id="pdfScrambles" type="hidden" name="scrambles" value='' />
<input type="submit" value=".pdf" />
</form>
<form id="zipForm" action="" method="POST" target="_blank">
<input id="zipScrambles" type="hidden" name="scrambles" value='' />
<input type="submit" value=".zip" />
</form>
</div>

</div>
</div>


</body>
</html>
