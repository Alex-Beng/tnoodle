<!DOCTYPE html>
<html>
<head>
<title>ScramblerTest</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<style type="text/css">
span.turn {
	color: black;
	text-decoration: underline;
	cursor: pointer;
}
span.currTurn {
	color: red;
}
img {
    border: none;
    padding: 1px;
}
area {/* apparently this doesn't work in opera or chrome */
    cursor: pointer;
}
pre {
    white-space: pre-wrap;
}
.titlebar {
    height: 20px;
    text-align: right;
    background-color: #CCC;
    border-bottom: 1px solid #666;
    cursor: move;
}
.titletext {
    float: left;
    padding-left: 5px;
}
.window {
    position: absolute;
    overflow: hidden;
    background-color: #EEE;
    border: 1px solid #333;
}
.button {
    font-family: sans-serif;
    cursor: pointer;
    padding: 2px;
}
.button:hover, .button.buttondown:hover {
    background-color: #888;
}
.button.buttondown, .button:active {
    background-color: #EEE;
    border-left: 1px solid #666;
    border-right: 1px solid #666;
}
.dragresize {
    background: none repeat scroll 0 0 #FFF;
    border: 1px solid #333;
    font-size: 1px;
    height: 5px;
    position: absolute;
    width: 5px;
}
.dragresize-br {
    cursor: se-resize;
    bottom: -1px;
    right: -1px;
}

</style>

<script type="text/javascript" src="tnoodle.js"></script>
<!-- http://www.jsmadeeasy.com/javascripts/DHMTL%20Miscelanious/drag_resize/drag_resize.htm -->
<script type="text/javascript" src="wz_dragdrop.js"></script>
<script type="text/javascript" src="ColorChooser.js"></script>
<script type="text/javascript">
	function deleteChildren(element) {
		while(element.firstChild)
			element.removeChild(element.firstChild);
	}
    function parsePx(px) {
        return parseInt(px.replace(/px/g, ""));
    }
    //resturns a shallow copy of obj
    function clone(obj) {
        var o = {};
        for(var k in obj)
            o[k] = obj[k];
        return o;
    }

	var scrambler = new tnoodle.scrambleserver('localhost', 8080);
    var faceMap = null;
	var currTurn = null;
    var isChangingColorScheme = false;

    var dragDrop = null;
    var scrambleDivDD = null;
	var puzzleSelect = null;
	var scrambleButton = null;
	var scramblePre = null;
	var scrambleDiv = null;
	var scrambleDivHeader = null;
    var scrambleHeaderText = null;
	var scrambleImg = null;
    var scrambleImgMap = null;
    var changeColors = null;

    var colorChooser = null;
    var colorChooserDiv = null;
    var colorChooserDD = null;
    var colorChooserHeaderText = null;

	function puzzlesLoaded(puzzles) {
		puzzleSelect.disabled = false;
		scrambleButton.disabled = false;
		scrambleButton.addEventListener('click', scramble, false);
		for(var i = 0; i < puzzles.length; i++) {
			puzzleSelect.options[puzzleSelect.options.length] = new Option(puzzles[i][1], puzzles[i][0]);
		}
	}

    var puzzle = null;
    var colorScheme = null;
    var defaultColorScheme = null;
	function scramble() {
		var newPuzzle = puzzleSelect.options[puzzleSelect.selectedIndex].value;
        if(newPuzzle != puzzle) {
            //puzzle change!
            colorScheme = null; //reset colorscheme
            currTurn = null;
            faceMap = null;
            puzzle = newPuzzle;

            scrambler.loadPuzzleImageInfo(function(faces, size, defColorScheme) {
                faceMap = faces;
                colorScheme = colorScheme || defColorScheme;
                defaultColorScheme = clone(defColorScheme);

                scrambleDivDD.minw = size.width;
                scrambleDivDD.minh = size.height;
                scrambleDivDD.paddingVert = getScrambleVertPadding();
                scrambleDivDD.paddingHorz = getScrambleHorzPadding();
                scrambleDiv.style.width = size.width + getScrambleHorzPadding() + "px";
                scrambleDiv.style.height = size.height + getScrambleVertPadding() + "px";
                scrambleResized();
            }, puzzle);
        }

		deleteChildren(scramblePre);
		scramblePre.appendChild(document.createTextNode('Loading scramble...'));
        scrambler.loadScramble(scrambleLoaded, puzzle, null);
	}
    function turnClicked() {
        if(isChangingColorScheme) {
            // first, we cancel editing of the colorscheme
            changeColorsClicked.call(changeColors);
        }
        scrambleDiv.style.display = 'inline'; // make scramble visible
        if(currTurn)
            currTurn.className = 'turn';
        currTurn = this;
        drawScramble(currTurn.incrementalScramble);
        currTurn.className = 'currTurn';
    }
	function scrambleLoaded(scramble) {
        deleteChildren(scramblePre);
		var turns = scramble.split(' ');
		var incrementalScramble = "";
		for(var i = 0; i < turns.length; i++) {
			var turn = turns[i];
			incrementalScramble += turn;
			var turnLink = document.createElement('span');
			turnLink.textContent = turn;
			turnLink.incrementalScramble = incrementalScramble;
			turnLink.setAttribute('class', 'turn');
			turnLink.addEventListener('click', turnClicked, false);
			scramblePre.appendChild(turnLink);
			if(i == turns.length-1) {
				turnClicked.call(turnLink);
			} else {
				incrementalScramble += " ";
				scramblePre.appendChild(document.createTextNode(' '));
            }
		}
	}

    var currFaceName = null;
    function faceClicked() {
        currFaceName = this.faceName;
        colorChooserDiv.style.display = 'inline';
        colorChooser.setDefaultColor(colorScheme[currFaceName]);
        deleteChildren(colorChooserHeaderText);
        colorChooserHeaderText.appendChild(document.createTextNode('Editing face ' + currFaceName));
    }

    var currScramble;
    function redrawScramble() {
        drawScramble(currScramble);
    }
	function drawScramble(scramble) {
        currScramble = scramble;
		scrambleImg.src = scrambler.getScrambleImageUrl(puzzle, scramble, colorScheme);
	}

    function getScrambleVertPadding() {
        //var headerStyle = window.getComputedStyle(scrambleDivHeader, null);
        //var scrambleHeader = parsePx(headerStyle.getPropertyValue("height")) + parsePx(headerStyle.getPropertyValue("border-bottom-width"));
        scrambleHeader = 20; //apprently dynamically computing this doesn't work on opera
        var scrambleStyle = window.getComputedStyle(scrambleImg, null);
        return parsePx(scrambleStyle.getPropertyValue("padding-top")) + parsePx(scrambleStyle.getPropertyValue("padding-bottom")) + scrambleHeader;
    }
    function getScrambleHorzPadding() {
        var scrambleStyle = window.getComputedStyle(scrambleImg, null);
        return parsePx(scrambleStyle.getPropertyValue("padding-left")) + parsePx(scrambleStyle.getPropertyValue("padding-right"));
    }

    function scrambleResized() {
        var imgWidth = parsePx(scrambleDiv.style.width) - getScrambleHorzPadding();
        scrambleImg.style.width = imgWidth + "px";
        scrambleImg.style.height = parsePx(scrambleDiv.style.height) - getScrambleVertPadding() + "px";

        deleteChildren(scrambleImgMap);
        if(isChangingColorScheme) {
            //TODO - only do the following when we're *done* resizing
            var scale = imgWidth / scrambleDivDD.minw;
            var areas = scrambler.createAreas(faceMap, scale);
            for(var i = 0; i < areas.length; i++) {
                var area = areas[i];
                area.setAttribute('alt', area.faceName);
                area.addEventListener('click', faceClicked, false);

                area.addEventListener('mouseover', function() { deleteChildren(scrambleHeaderText); scrambleHeaderText.appendChild(document.createTextNode(this.faceName)); }, false);
                area.addEventListener('mouseout', function() { deleteChildren(scrambleHeaderText); }, false);
                scrambleImgMap.appendChild(area);
            }
        }
    }

    function changeColorsClicked() {
        isChangingColorScheme = !isChangingColorScheme;
        if(isChangingColorScheme) {
            if(currTurn)
                currTurn.className = "turn";
            this.className += " buttondown";
            resetColorScheme.style.display = 'inline';
            drawScramble("");
        } else {
            if(currTurn) //curr turn will not be defined if we just changed puzzles
                turnClicked.call(currTurn);
            this.className = this.className.replace(/\bbuttondown\b/, "");
            colorChooserDiv.style.display = 'none'; //close cholor chooser window
            resetColorScheme.style.display = 'none';
        }
        scrambleResized(); //force image area map to be created
    }

	window.addEventListener('load', function() {
		scrambler.loadAvailablePuzzles(puzzlesLoaded);
		scramblePre = document.getElementById('scramblePre');

        scrambleDiv = document.getElementById('scrambleDiv');
        scrambleDivHeader = document.getElementById("scrambleDivHeader");
        scrambleHeaderText = document.getElementById("scrambleHeaderText");

		scrambleImg = document.getElementById('scrambleImg');
        scrambleImgMap = document.getElementById('scrambleImgMap');
		scrambleButton = document.getElementById('scrambleButton');
		puzzleSelect = document.getElementById('puzzleSelect');

        scrambleButton.disabled = puzzleSelect.disabled = true;

        dragDrop = new DragDrop();
        scrambleDivDD = dragDrop.createDraggable(RESET_Z, SCALABLE, scrambleDiv.id);
        scrambleDivDD.resizeFunc = scrambleResized;
        
        scrambleDiv.style.display = 'none'; //this has to be after the element is set draggable
        document.getElementById('closeScramble').addEventListener('click', function() {
            currTurn.setAttribute('class', 'turn');
            scrambleDiv.style.display = 'none';
            colorChooserDiv.style.display = 'none';
        }, false); 
        changeColors = document.getElementById('changeColors');
        changeColors.addEventListener('click', changeColorsClicked, false);

        colorChooser = new ColorChooser(function(newColor) {
            colorScheme[currFaceName] = newColor;
            colorChooserDiv.style.display = 'none';
            redrawScramble();
        });
        colorChooserDiv = document.getElementById('colorChooserDiv');
        colorChooserDD = dragDrop.createDraggable(RESET_Z, colorChooserDiv.id);
        colorChooserDiv.appendChild(colorChooser.element);
        colorChooserDiv.style.width = colorChooser.preferredWidth + 'px';
        colorChooserDiv.style.height = colorChooser.preferredHeight + 'px';
        colorChooserDiv.style.display = 'none';

        colorChooserHeaderText = document.getElementById('colorChooserHeaderText');
        document.getElementById('closeColorChooser').addEventListener('click', function() {
            colorChooserDiv.style.display = 'none';
        }, false);
        resetColorScheme = document.getElementById('resetColorScheme');
        resetColorScheme.style.display = 'none';
        resetColorScheme.addEventListener('click', function() {
            colorScheme = clone(defaultColorScheme);
            redrawScramble();
        }, false);
	}, false);
</script>

</head>
<body>
<select id="puzzleSelect"></select>
<input type="button" id="scrambleButton" value="Scramble!" /><br />
<pre id="scramblePre"></pre>

<!-- Markup for the color chooser -->
<div id="colorChooserDiv" class="window" style="z-index: 1">
<div class="titlebar">
    <span id="colorChooserHeaderText" class="titletext"></span>
    <span id="closeColorChooser" class="button">X</span>
</div>
</div>

<!-- Markup for the scramble window -->
<div id="scrambleDiv" class="window">
<div id="scrambleDivHeader" class="titlebar">
    <span id="scrambleHeaderText" class="titletext"></span>
    <span id="resetColorScheme" class="button" title="Reset color scheme">*</span>
    <span id="changeColors" class="button" title="Change color scheme">#</span>
    <span id="closeScramble" class="button">X</span>
</div>
<img id="scrambleImg" usemap="#scrambleImgMap" src="" />
<div class="dragresize dragresize-br"></div>
</div>
<map id="scrambleImgMap" name="scrambleImgMap"></map>

</body>
</html>
